FROM quay.io/keycloak/keycloak:22.0.1

# Set user as root for installations
USER root
RUN microdnf install -y curl && microdnf clean all
USER keycloak

# Copy any custom configurations  
COPY --chown=keycloak:keycloak . /opt/keycloak/

# Environment variables for build
ENV KC_DB=postgres
ENV KC_HOSTNAME_STRICT=false
ENV KC_PROXY=edge
ENV KC_HTTP_ENABLED=true
ENV KC_HEALTH_ENABLED=true

# Build optimized Keycloak
RUN /opt/keycloak/bin/kc.sh build

# Expose the port that Render expects
EXPOSE $PORT
EXPOSE 8080

ENTRYPOINT ["/opt/keycloak/bin/kc.sh"]
CMD ["start", "--http-port=${PORT:-8080}", "--hostname-strict=false", "--proxy=edge", "--http-enabled=true"]
